<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fantasy Auction Assistant — Draft Board</title>
<!-- SheetJS for in-browser Excel import -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<style>
  :root { --pad: 10px; --gap: 12px; --radius: 10px; }
  * { box-sizing: border-box; }
  body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #111; background: #f7f7f9; }
  header { padding: 18px var(--pad); background: #111; color: #fff; }
  header h1 { margin: 0; font-size: 20px; }
  main { padding: 18px var(--pad); max-width: 1280px; margin: 0 auto; }
  .grid { display: grid; gap: var(--gap); }
  .grid-2 { grid-template-columns: 1fr 1fr; }
  .draft-layout { display:grid; grid-template-columns: 0.7fr 1.3fr; gap: var(--gap); }
  .card { background: #fff; border: 1px solid #e6e6ee; border-radius: var(--radius); padding: 16px; }
  .card h2 { margin: 0 0 10px 0; font-size: 16px; }
  .row { display: flex; flex-wrap: wrap; gap: 10px 14px; align-items: center; }
  label { font-size: 13px; color: #333; }
  input, select, button { padding: 8px; border-radius: 8px; border: 1px solid #cfd1d6; font-size: 14px; }
  button { background: #111; color:#fff; cursor: pointer; }
  button.secondary { background:#fff; color:#111; }
  input[type="number"] { width: 110px; }
  .kpi { display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:12px; margin-top:8px; }
  .kpi .tile { background:#fafafa; border:1px solid #eee; border-radius:10px; padding:12px; }
  .muted { color:#666; font-size:12px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .right { text-align:right; }
  .table-wrap { overflow:auto; border:1px solid #e6e6ee; border-radius: var(--radius); }
  table { width:100%; border-collapse: collapse; font-size:13px; }
  th, td { padding: 9px 10px; border-bottom: 1px solid #f0f0f3; white-space: nowrap; }
  th { position: sticky; top: 0; background: #f5f6fa; z-index: 1; text-align: left; }
  tbody tr:hover { filter: brightness(0.98); }

  /* Position color tints */
  .pos-QB { background: #ffe5e5; } /* red tint */
  .pos-RB { background: #e6f0ff; } /* blue tint */
  .pos-WR { background: #e8f7e8; } /* green tint */
  .pos-TE { background: #fff1e0; } /* orange tint */
  .pos-DST { background: #f1f1f1; }
  .pos-K { background: #f1f1f1; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; background:#fff; }

  /* Positional Value Tracking */
  .pv-grid { width: 100%; }
  .pv-grid th, .pv-grid td { text-align: right; }
  .pv-grid th:first-child, .pv-grid td:first-child { text-align: left; }
  .pv-grid .value-pos { font-weight: 600; }
  .good { color: #0c7a43; }
  .bad { color: #b00020; }
  .bucket-1 { background: #fff5c2; }  /* yellow */
  .bucket-0 { background: #ffd6d6; }  /* red */

  /* My lineup table */
  .lineup th { text-align:left; }
  .lineup td { white-space: normal; }
  .slot { display:flex; justify-content:space-between; gap:8px; }
  .slot .name { overflow:hidden; text-overflow:ellipsis; }
  .slot .price { font-weight:600; }

  .hint { background:#fffbed; border:1px dashed #ffd38a; padding:10px; border-radius:8px; margin-top:10px; }
</style>
</head>
<body>
<header>
  <h1>Fantasy Auction Assistant — Draft Board</h1>
</header>

<main class="grid">
  <!-- Top row: My Team (lineup) + League & Team -->
  <section class="grid grid-2">
    <div class="card">
      <h2>My Team (Lineup)</h2>
      <div class="table-wrap">
        <table class="lineup">
          <thead>
            <tr><th>Slot</th><th>Player</th><th class="right">Paid</th></tr>
          </thead>
          <tbody id="lineupBody"></tbody>
          <tfoot>
            <tr><th colspan="2" class="right">Total Paid</th><th class="right" id="lineupPaid">$0</th></tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>League & Team</h2>
      <div class="row">
        <label>Teams <input id="teamsCount" type="number" min="2" value="12"></label>
        <label>Budget / Team <input id="budgetPerTeam" type="number" min="1" value="200"></label>
        <label>Your Team Name <input id="yourTeamName" type="text" value="You"></label>
        <label>Bench Slots <input id="benchSlots" type="number" min="0" value="6"></label>
      </div>
      <div class="kpi">
        <div class="tile"><div class="muted">Your Remaining Budget</div><div class="mono" id="yourRemaining">$0</div></div>
        <div class="tile"><div class="muted">Players on Your Team</div><div class="mono" id="yourPlayers">0</div></div>
        <div class="tile"><div class="muted">Your Max Bid</div><div class="mono" id="yourMaxBid">$0</div></div>
      </div>
      <div class="row" style="margin-top:10px; gap:8px;">
        <input id="importFile" type="file" accept=".xlsx,.xls,.json" style="display:none;">
        <button id="importBtn" class="secondary">Import Rankings (Excel/JSON)</button>
        <button id="exportBtn" class="secondary">Export State (JSON)</button>
      </div>
      <div class="hint">If no players appear, click <b>Import Rankings</b> and select your Excel file. Use sheet “<b>Rankings and Tiers</b>”. Expected columns: Player, Position, Overall, Pos Rank, Tier, Auction (Out of $200).</div>
    </div>
  </section>

  <!-- Positional Value Tracking (full width) -->
  <section class="card">
    <h2>Positional Value Tracking</h2>
    <div class="table-wrap">
      <table class="pv-grid" id="pvTable">
        <thead id="pvHead"></thead>
        <tbody id="pvBody"></tbody>
      </table>
    </div>
    <div class="muted" style="margin-top:6px;">
      A player counts as <b>drafted</b> once an <b>Actual Auction Value</b> is entered (&gt; 0). Remaining = not yet drafted.
      Positional Value = (sum Actual − sum Recommended) / sum Recommended for drafted players at that position.
      Buckets: 1–5, 6–10, …, 26–30, then 31–40, 41–50, 51–60, … with <span class="bucket-1">1 left</span> and <span class="bucket-0">0 left</span> highlighting.
    </div>
  </section>

  <!-- Bottom: small Filters (left) + narrower Draft Board (right) -->
  <section class="draft-layout">
    <div class="card">
      <h2>Filters</h2>
      <div class="controls">
        <label>Search <input id="search" type="text" placeholder="Search player..."></label>
        <label>Position
          <select id="filterPos">
            <option value="">All</option>
            <option>QB</option><option>RB</option><option>WR</option><option>TE</option><option>DST</option><option>K</option>
          </select>
        </label>
        <label>Tier
          <select id="filterTier">
            <option value="">All</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
          </select>
        </label>
        <button id="clearFilters">Clear</button>
      </div>
    </div>

    <div class="card">
      <h2>Draft Board</h2>
      <div class="table-wrap">
        <table id="board">
          <thead>
            <tr>
              <th>Player Name</th>
              <th>Position</th>
              <th>Rank</th>
              <th>Position Rank</th>
              <th>Tier</th>
              <th class="right">Recommended Auction Value</th>
              <th class="right">Actual Auction Value</th>
              <th>My Team?</th>
            </tr>
          </thead>
          <tbody id="boardBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script>
const LS_KEY = "ffa_draft_board_v6"; // bump when changing data model
const state = {
  settings: {
    teamsCount: 12,
    budgetPerTeam: 200,
    yourTeamName: "You",
    benchSlots: 6,
    // Lineup structure: 1 QB, 2 RB, 2 WR, 1 TE, 1 FLEX, 1 DST, 1 K
    slots: { QB:1, RB:2, WR:2, TE:1, FLEX:1, DST:1, K:1 }
  },
  players: [] // {name,pos,rank,posRank,tier,base,actual,myTeam}
};

function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function load(){
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return false;
  try { Object.assign(state, JSON.parse(raw)); return true; } catch(e){ return false; }
}
function dollars(x){ if (!isFinite(x)) return "$0"; return "$" + Math.round(x); }
function normPos(s){
  const p = String(s||"").trim().toUpperCase();
  if (["DST","D/ST","DEF","D"].includes(p)) return "DST";
  if (p==="PK") return "K";
  if (["QB","RB","WR","TE","DST","K"].includes(p)) return p;
  return p || "";
}
function computeKPIs(){
  const spent = state.players.reduce((sum,p)=> sum + (p.myTeam ? (Number(p.actual)||0) : 0), 0);
  const remaining = (Number(state.settings.budgetPerTeam)||200) - spent;
  const yourCount = state.players.filter(p=>p.myTeam && Number(p.actual)>0).length;
  const totalSlots = state.settings.slots.QB + state.settings.slots.RB + state.settings.slots.WR + state.settings.slots.TE + state.settings.slots.FLEX + state.settings.slots.DST + state.settings.slots.K + (Number(state.settings.benchSlots)||6);
  const openSlots = Math.max(0, totalSlots - yourCount);
  const maxBid = Math.max(0, remaining - Math.max(0, openSlots - 1));
  document.getElementById("yourRemaining").textContent = dollars(remaining);
  document.getElementById("yourPlayers").textContent = yourCount;
  document.getElementById("yourMaxBid").textContent = dollars(maxBid);
}

/* --------- Draft Board ---------- */
function renderDraftBoard(){
  const body = document.getElementById("boardBody");
  const q = (document.getElementById("search").value || "").toLowerCase();
  const fPos = document.getElementById("filterPos").value;
  const fTier = document.getElementById("filterTier").value;

  body.innerHTML = "";
  state.players
    .filter(p => !q || p.name.toLowerCase().includes(q))
    .filter(p => !fPos || p.pos === fPos)
    .filter(p => !fTier || String(p.tier) === fTier)
    .sort((a,b) => a.rank - b.rank)
    .forEach((p, idx) => {
      const tr = document.createElement("tr");
      tr.className = "pos-" + (p.pos || "UNK");
      tr.innerHTML = `
        <td>${p.name}</td>
        <td><span class="badge">${p.pos}</span></td>
        <td>${p.rank ?? ""}</td>
        <td>${p.posRank ?? ""}</td>
        <td>${p.tier ?? ""}</td>
        <td class="right mono">${dollars(p.base)}</td>
        <td class="right"><input type="number" min="0" step="1" data-i="${idx}" data-k="actual" value="${p.actual||0}"></td>
        <td>
          <select data-i="${idx}" data-k="myTeam">
            <option value="false" ${p.myTeam ? "" : "selected"}>No</option>
            <option value="true" ${p.myTeam ? "selected" : ""}>Yes</option>
          </select>
        </td>
      `;
      body.appendChild(tr);
    });

  body.querySelectorAll("input,select").forEach(el => el.addEventListener("change", onEdit));
  computeKPIs();
  renderLineup();
  renderPositionalValueTracking();
}

function onEdit(e){
  const i = Number(e.target.dataset.i);
  const k = e.target.dataset.k;
  if (k === "actual"){
    state.players[i].actual = Number(e.target.value)||0;
  } else if (k === "myTeam"){
    state.players[i].myTeam = (e.target.value === "true");
  }
  save();
  computeKPIs();
  renderLineup();
  renderPositionalValueTracking();
}

/* --------- Lineup auto-fill ---------- */
function assignRoster(){
  const s = state.settings.slots;
  const lineup = { QB:[], RB:[], WR:[], TE:[], FLEX:[], DST:[], K:[], BENCH:[] };
  const canFlex = pos => (pos==="RB"||pos==="WR"||pos==="TE");
  const mine = state.players.filter(p=>p.myTeam && Number(p.actual)>0).sort((a,b)=> a.rank - b.rank);

  for (const p of mine){
    let placed = false;
    if (p.pos in lineup){
      const need = s[p.pos] || 0;
      if (lineup[p.pos].length < need){
        lineup[p.pos].push(p); placed = true;
      }
    }
    if (!placed && canFlex(p.pos)){
      const needF = s.FLEX || 0;
      if (lineup.FLEX.length < needF){
        lineup.FLEX.push(p); placed = true;
      }
    }
    if (!placed){
      const benchNeed = Number(state.settings.benchSlots)||6;
      if (lineup.BENCH.length < benchNeed){
        lineup.BENCH.push(p); placed = true;
      }
    }
  }
  return lineup;
}

function renderLineup(){
  const body = document.getElementById("lineupBody");
  const paidCell = document.getElementById("lineupPaid");
  const s = state.settings.slots;
  const L = assignRoster();
  body.innerHTML = "";
  let paid = 0;

  function rowFor(slot, arr, maxCount){
    for (let i=0; i<maxCount; i++){
      const p = arr[i];
      const name = p ? p.name : "<span class='muted'>—</span>";
      const price = p ? dollars(Number(p.actual)||0) : "$0";
      if (p) paid += Number(p.actual)||0;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${slot}</td><td class="slot"><span class="name">${name}</span></td><td class="right price">${price}</td>`;
      body.appendChild(tr);
    }
  }

  rowFor("QB", L.QB, s.QB||0);
  rowFor("RB", L.RB, s.RB||0);
  rowFor("WR", L.WR, s.WR||0);
  rowFor("TE", L.TE, s.TE||0);
  rowFor("FLEX", L.FLEX, s.FLEX||0);
  rowFor("DST", L.DST, s.DST||0);
  rowFor("K", L.K, s.K||0);
  rowFor("BENCH", L.BENCH, Number(state.settings.benchSlots)||6);

  paidCell.textContent = dollars(paid);
}

/* --------- Positional Value Tracking ---------- */
function buildBuckets(){
  const maxPosRank = state.players.reduce((m,p)=> Math.max(m, Number(p.posRank)||0), 0);
  const buckets = [];
  for (let start=1; start<=30; start+=5){ buckets.push([start, start+4]); }  // 1-5,6-10,...,26-30
  let start = 31;
  while (start <= maxPosRank){ buckets.push([start, start+9]); start += 10; } // 31-40, 41-50, ...
  return buckets;
}
function formatPositionalValue(pos){
  const drafted = state.players.filter(p => p.pos === pos && Number(p.actual)>0);
  const spend = drafted.reduce((s,p)=> s + (Number(p.actual)||0), 0);
  const rec = drafted.reduce((s,p)=> s + (Number(p.base)||0), 0);
  if (rec <= 0) return { text: "—", cls: "" };
  const diff = spend - rec;
  const pct = (diff / rec) * 100;
  const rounded = Math.round(Math.abs(pct));
  const greater = pct > 0;
  return { text: `${rounded}% ${greater ? "Greater" : "Less"} Than Rec.`, cls: greater ? "bad" : "good" };
}
function renderPositionalValueTracking(){
  const head = document.getElementById("pvHead");
  const body = document.getElementById("pvBody");
  const buckets = buildBuckets();

  head.innerHTML = "";
  const htr = document.createElement("tr");
  htr.innerHTML = `<th>Position</th><th>Positional Value</th><th>Remaining Players Available</th>` + buckets.map(b => `<th>${b[0]}–${b[1]}</th>`).join("");
  head.appendChild(htr);

  body.innerHTML = "";
  ["QB","RB","WR","TE"].forEach(pos => {
    const remaining = state.players.filter(p => p.pos === pos && (!p.actual || Number(p.actual) === 0));
    const valueInfo = formatPositionalValue(pos);
    const tr = document.createElement("tr");
    let html = `<td>${pos}</td><td class="value-pos ${valueInfo.cls}">${valueInfo.text}</td><td>${remaining.length}</td>`;
    for (const [start,end] of buckets){
      const count = remaining.filter(p => (Number(p.posRank)||0) >= start && (Number(p.posRank)||0) <= end).length;
      let cls = "";
      if (count === 0) cls = "bucket-0";
      else if (count === 1) cls = "bucket-1";
      html += `<td class="${cls}">${count}</td>`;
    }
    tr.innerHTML = html;
    body.appendChild(tr);
  });
}

/* --------- Import/Export ---------- */
function tryImportJSON(text){
  const data = JSON.parse(text);
  if (data.players && Array.isArray(data.players)){
    state.players = data.players;
  } else if (Array.isArray(data)){ // plain players array
    state.players = data;
  } else {
    throw new Error("JSON format not recognized.");
  }
}
function rowsFromSheet(sheet){
  return XLSX.utils.sheet_to_json(sheet, { defval: "" });
}
function toPlayersFromRows(rows){
  // Map columns: Player, Position, Overall, Pos Rank, Tier, Auction (Out of $200)
  return rows.map(r => ({
    name: String(r["Player"] ?? r["Name"] ?? "").trim(),
    pos: normPos(r["Position"]),
    rank: Number(r["Overall"] ?? r["Rank"] ?? 0) || 0,
    posRank: Number(r["Pos Rank"] ?? r["Position Rank"] ?? 0) || 0,
    tier: String(r["Tier"] ?? "").trim(),
    base: Number(r["Auction (Out of $200)"] ?? r["Auction"] ?? 0) || 0,
    actual: 0,
    myTeam: false
  })).filter(p => p.name && p.pos);
}
document.getElementById("importBtn").addEventListener("click", ()=> document.getElementById("importFile").click());
document.getElementById("importFile").addEventListener("change", (evt)=>{
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    try {
      if (file.name.toLowerCase().endsWith(".json")){
        tryImportJSON(e.target.result);
      } else {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:"array"});
        // Prefer "Rankings and Tiers" sheet; fallback to first sheet
        const sheet = wb.Sheets["Rankings and Tiers"] || wb.Sheets[wb.SheetNames[0]];
        const rows = rowsFromSheet(sheet);
        state.players = toPlayersFromRows(rows);
      }
      save();
      computeKPIs();
      renderLineup();
      renderPositionalValueTracking();
      renderDraftBoard();
    } catch(err){
      alert("Import failed: " + err.message);
    } finally {
      evt.target.value = "";
    }
  };
  if (file.name.toLowerCase().endsWith(".json")) reader.readAsText(file);
  else reader.readAsArrayBuffer(file);
});
document.getElementById("exportBtn").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "auction_state.json"; a.click();
  URL.revokeObjectURL(url);
});

/* --------- Settings & Filters ---------- */
["teamsCount","budgetPerTeam","yourTeamName","benchSlots"].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("change", () => {
    state.settings.teamsCount = Number(document.getElementById("teamsCount").value)||12;
    state.settings.budgetPerTeam = Number(document.getElementById("budgetPerTeam").value)||200;
    state.settings.yourTeamName = document.getElementById("yourTeamName").value || "You";
    state.settings.benchSlots = Number(document.getElementById("benchSlots").value)||6;
    save(); computeKPIs(); renderLineup();
  });
});
document.getElementById("search").addEventListener("input", renderDraftBoard);
document.getElementById("filterPos").addEventListener("change", renderDraftBoard);
document.getElementById("filterTier").addEventListener("change", renderDraftBoard);
document.getElementById("clearFilters").addEventListener("click", () => {
  document.getElementById("search").value = "";
  document.getElementById("filterPos").value = "";
  document.getElementById("filterTier").value = "";
  renderDraftBoard();
});

/* --------- Init ---------- */
(function init(){
  const ok = load(); // load persisted state if any
  document.getElementById("teamsCount").value = state.settings.teamsCount;
  document.getElementById("budgetPerTeam").value = state.settings.budgetPerTeam;
  document.getElementById("yourTeamName").value = state.settings.yourTeamName;
  document.getElementById("benchSlots").value = state.settings.benchSlots;
  computeKPIs();
  renderLineup();
  renderPositionalValueTracking();
  renderDraftBoard();
})();
</script>
</body>
</html>
