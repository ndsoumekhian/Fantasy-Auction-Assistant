<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fantasy Auction Assistant — Draft Board</title>
<!-- Excel import (optional): you can still import a new sheet mid-draft -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<style>
  :root { --pad: 10px; --gap: 12px; --radius: 10px; }
  * { box-sizing: border-box; }
  body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #111; background: #f7f7f9; }
  header { padding: 18px var(--pad); background: #111; color: #fff; }
  header h1 { margin: 0; font-size: 20px; }
  main { padding: 18px var(--pad); max-width: 1400px; margin: 0 auto; }

  /* 3-column layout: left (team/filters), middle (league/recs/board), right (log) */
  .main-grid { display: grid; gap: var(--gap); grid-template-columns: 1.2fr 1.2fr 0.8fr; align-items: start; }
  .span-2 { grid-column: 1 / span 2; }
  .col-1 { grid-column: 1; }
  .col-2 { grid-column: 2; }
  .col-3 { grid-column: 3; }
  .row-1 { grid-row: 1; }
  .row-2 { grid-row: 2; }
  .row-3 { grid-row: 3; }

  .card { background: #fff; border: 1px solid #e6e6ee; border-radius: var(--radius); padding: 14px; }
  .card h2 { margin: 0 0 8px 0; font-size: 16px; }

  .compact * { font-size: 13px; }
  .compact input, .compact select, .compact button { padding: 6px; border-radius: 8px; }
  .compact .row { gap: 8px 10px; }

  .row { display: flex; flex-wrap: wrap; gap: 10px 14px; align-items: center; }
  label { font-size: 13px; color: #333; }
  input, select, button { padding: 8px; border-radius: 8px; border: 1px solid #cfd1d6; font-size: 14px; }
  button { background: #111; color:#fff; cursor: pointer; }
  button.secondary { background:#fff; color:#111; }
  input[type="number"] { width: 110px; }

  .kpi { display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:10px; margin-top:6px; }
  .kpi .tile { background:#fafafa; border:1px solid #eee; border-radius:10px; padding:10px; }
  .muted { color:#666; font-size:12px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .right { text-align:right; }

  .table-wrap { overflow:auto; border:1px solid #e6e6ee; border-radius: var(--radius); }
  table { width:100%; border-collapse: collapse; font-size:13px; }
  th, td { padding: 9px 10px; border-bottom: 1px solid #f0f0f3; white-space: nowrap; }
  th { position: sticky; top: 0; background: #f5f6fa; z-index: 1; text-align: left; }
  tbody tr:hover { filter: brightness(0.98); }

  /* Position tints */
  .pos-QB { background: #ffe5e5; } /* red */
  .pos-RB { background: #e6f0ff; } /* blue */
  .pos-WR { background: #e8f7e8; } /* green */
  .pos-TE { background: #fff1e0; } /* orange */
  .pos-DST, .pos-K { background: #f1f1f1; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; background:#fff; }

  /* Positional Value Tracking */
  .pv-grid { width: 100%; }
  .pv-grid th, .pv-grid td { text-align: right; }
  .pv-grid th:first-child, .pv-grid td:first-child { text-align: left; }
  .pv-grid .value-pos { font-weight: 600; }
  .good { color: #0c7a43; }
  .bad { color: #b00020; }
  .bucket-1 { background: #fff5c2; }  /* 1 left */
  .bucket-0 { background: #ffd6d6; }  /* 0 left */

  /* Lineup table */
  .lineup th { text-align:left; }
  .lineup td { white-space: normal; }
  .slot { display:flex; justify-content:space-between; gap:8px; }
  .slot .name { overflow:hidden; text-overflow:ellipsis; }
  .slot .price { font-weight:600; }

  /* Draft Log */
  .log-list { list-style: none; padding: 0; margin: 0; }
  .log-item { display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px solid #f0f0f3; }
  .log-item .who { font-weight:600; }
  .log-item .amt { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
</style>
</head>
<body>
<header>
  <h1>Fantasy Auction Assistant — Draft Board</h1>
</header>

<!-- Paste the JSON from block (2) into the [{"name":"Ja'Marr Chase","pos":"WR","rank":1,"posRank":1,"tier":"1","base":63.0,"actual":0,"myTeam":false},{"name":"Bijan Robinson","pos":"RB","rank":2,"posRank":1,"tier":"1","base":62.0,"actual":0,"myTeam":false},{"name":"Jahmyr Gibbs","pos":"RB","rank":3,"posRank":2,"tier":"1","base":61.0,"actual":0,"myTeam":false},{"name":"Saquon Barkley","pos":"RB","rank":4,"posRank":3,"tier":"1","base":57.0,"actual":0,"myTeam":false},{"name":"CeeDee Lamb","pos":"WR","rank":5,"posRank":2,"tier":"1","base":60.0,"actual":0,"myTeam":false},{"name":"Christian McCaffrey","pos":"RB","rank":6,"posRank":4,"tier":"1","base":69.0,"actual":0,"myTeam":false},{"name":"Justin Jefferson","pos":"WR","rank":7,"posRank":3,"tier":"1","base":57.0,"actual":0,"myTeam":false},{"name":"Breece Hall","pos":"RB","rank":8,"posRank":5,"tier":"1","base":52.0,"actual":0,"myTeam":false},{"name":"Amon-Ra St. Brown","pos":"WR","rank":9,"posRank":4,"tier":"1","base":52.0,"actual":0,"myTeam":false},{"name":"Tyreek Hill","pos":"WR","rank":10,"posRank":5,"tier":"1","base":52.0,"actual":0,"myTeam":false}
,
{"name":"A.J. Brown","pos":"WR","rank":11,"posRank":6,"tier":"1","base":51.0,"actual":0,"myTeam":false},{"name":"Jalen Hurts","pos":"QB","rank":12,"posRank":1,"tier":"1","base":36.0,"actual":0,"myTeam":false},{"name":"C.J. Stroud","pos":"QB","rank":13,"posRank":2,"tier":"1","base":23.0,"actual":0,"myTeam":false},{"name":"Jalen Waddle","pos":"WR","rank":14,"posRank":7,"tier":"1","base":41.0,"actual":0,"myTeam":false},{"name":"Garrett Wilson","pos":"WR","rank":15,"posRank":8,"tier":"1","base":41.0,"actual":0,"myTeam":false},{"name":"Jahaan Dotson","pos":"WR","rank":16,"posRank":9,"tier":"1","base":4.0,"actual":0,"myTeam":false},{"name":"Derrick Henry","pos":"RB","rank":17,"posRank":6,"tier":"1","base":42.0,"actual":0,"myTeam":false},{"name":"Aidan O'Connell","pos":"QB","rank":18,"posRank":3,"tier":"1","base":1.0,"actual":0,"myTeam":false},{"name":"De'Von Achane","pos":"RB","rank":19,"posRank":7,"tier":"1","base":38.0,"actual":0,"myTeam":false},{"name":"Sam LaPorta","pos":"TE","rank":20,"posRank":1,"tier":"1","base":22.0,"actual":0,"myTeam":false}
,
{"name":"Deebo Samuel","pos":"WR","rank":21,"posRank":10,"tier":"1","base":35.0,"actual":0,"myTeam":false},{"name":"Josh Allen","pos":"QB","rank":22,"posRank":4,"tier":"1","base":27.0,"actual":0,"myTeam":false},{"name":"Kyren Williams","pos":"RB","rank":23,"posRank":8,"tier":"1","base":41.0,"actual":0,"myTeam":false},{"name":"Almond-Ra Snack Brown","pos":"WR","rank":24,"posRank":11,"tier":"1","base":1.0,"actual":0,"myTeam":false},{"name":"Nico Collins","pos":"WR","rank":25,"posRank":12,"tier":"1","base":32.0,"actual":0,"myTeam":false},{"name":"Puka Nacua","pos":"WR","rank":26,"posRank":13,"tier":"1","base":32.0,"actual":0,"myTeam":false},{"name":"Amon-Ra St. Beige","pos":"WR","rank":27,"posRank":14,"tier":"1","base":1.0,"actual":0,"myTeam":false},{"name":"Michael Pittman Jr.","pos":"WR","rank":28,"posRank":15,"tier":"1","base":30.0,"actual":0,"myTeam":false},{"name":"Travis Kelce","pos":"TE","rank":29,"posRank":2,"tier":"1","base":26.0,"actual":0,"myTeam":false},{"name":"Drake London","pos":"WR","rank":30,"posRank":16,"tier":"1","base":28.0,"actual":0,"myTeam":false}
,
{"name":"Davante Adams","pos":"WR","rank":31,"posRank":17,"tier":"1","base":32.0,"actual":0,"myTeam":false},{"name":"Kenneth Walker III","pos":"RB","rank":32,"posRank":9,"tier":"1","base":29.0,"actual":0,"myTeam":false},{"name":"Isiah Pacheco","pos":"RB","rank":33,"posRank":10,"tier":"1","base":29.0,"actual":0,"myTeam":false},{"name":"Joe Mixon","pos":"RB","rank":34,"posRank":11,"tier":"1","base":29.0,"actual":0,"myTeam":false},{"name":"Anthony Richardson","pos":"QB","rank":35,"posRank":5,"tier":"1","base":21.0,"actual":0,"myTeam":false},{"name":"Lamb, CeeDee","pos":"WR","rank":36,"posRank":18,"tier":"1","base":1.0,"actual":0,"myTeam":false},{"name":"Stefon Diggs","pos":"WR","rank":37,"posRank":19,"tier":"1","base":27.0,"actual":0,"myTeam":false},{"name":"DeVonta Smith","pos":"WR","rank":38,"posRank":20,"tier":"1","base":27.0,"actual":0,"myTeam":false},{"name":"Rachaad White","pos":"RB","rank":39,"posRank":12,"tier":"1","base":26.0,"actual":0,"myTeam":false},{"name":"James Cook","pos":"RB","rank":40,"posRank":13,"tier":"1","base":26.0,"actual":0,"myTeam":false}
...] below -->
<script type="application/json" id="players-data">[]</script>

<main class="main-grid">
  <!-- My Team -->
  <section class="card col-1 row-1">
    <h2>My Team (Lineup)</h2>
    <div class="table-wrap">
      <table class="lineup">
        <thead>
          <tr><th>Slot</th><th>Player</th><th class="right">Paid</th></tr>
        </thead>
        <tbody id="lineupBody"></tbody>
        <tfoot>
          <tr><th colspan="2" class="right">Total Paid</th><th class="right" id="lineupPaid">$0</th></tr>
        </tfoot>
      </table>
    </div>
  </section>

  <!-- League & Team (compact) + Recommended Players -->
  <section class="card col-2 row-1 compact">
    <h2>League & Team</h2>
    <div class="row">
      <label>Teams <input id="teamsCount" type="number" min="2" value="12"></label>
      <label>Budget <input id="budgetPerTeam" type="number" min="1" value="200"></label>
      <label>Your Team <input id="yourTeamName" type="text" value="You"></label>
      <label>Bench <input id="benchSlots" type="number" min="0" value="6"></label>
    </div>
    <div class="kpi">
      <div class="tile"><div class="muted">Remaining</div><div class="mono" id="yourRemaining">$0</div></div>
      <div class="tile"><div class="muted">Rostered</div><div class="mono" id="yourPlayers">0</div></div>
      <div class="tile"><div class="muted">Max Bid</div><div class="mono" id="yourMaxBid">$0</div></div>
    </div>
    <div class="row" style="margin-top:8px; gap:8px;">
      <input id="importFile" type="file" accept=".xlsx,.xls,.json" style="display:none;">
      <button id="importBtn" class="secondary">Import Rankings (Excel/JSON)</button>
      <button id="exportBtn" class="secondary">Export State (JSON)</button>
    </div>

    <h2 style="margin-top:12px;">Recommended Players Available</h2>
    <div class="table-wrap">
      <table id="recsTable">
        <thead>
          <tr><th>Pos</th><th>Player</th><th class="right">Rec. $</th><th class="right">Rank</th></tr>
        </thead>
        <tbody id="recsBody"></tbody>
      </table>
    </div>
    <div class="muted" style="margin-top:6px;">Shows best remaining players for your <b>starting</b> needs (and FLEX if open).</div>
  </section>

  <!-- Draft Log (right sidebar) -->
  <section class="card col-3 row-1" style="grid-row: 1 / span 3;">
    <h2>Draft Log</h2>
    <ul id="draftLog" class="log-list"></ul>
  </section>

  <!-- Positional Value Tracking -->
  <section class="card span-2 row-2">
    <h2>Positional Value Tracking</h2>
    <div class="table-wrap">
      <table class="pv-grid" id="pvTable">
        <thead id="pvHead"></thead>
        <tbody id="pvBody"></tbody>
      </table>
    </div>
    <div class="muted" style="margin-top:6px;">
      A player counts as <b>drafted</b> when <b>Actual Auction Value</b> &gt; 0. Remaining = not yet drafted.
      Positional Value = (sum Actual − sum Recommended) / sum Recommended for drafted players at that position.
      Buckets: 1–5, 6–10, 11–15, 16–20, 21–25, 26–30, 31–40, 41–50 (<span class="bucket-1">yellow at 1</span>, <span class="bucket-0">red at 0</span>).
    </div>
  </section>

  <!-- Filters + Draft Board -->
  <section class="card col-1 row-3">
    <h2>Filters</h2>
    <div class="controls">
      <label>Search <input id="search" type="text" placeholder="Search player..."></label>
      <label>Position
        <select id="filterPos">
          <option value="">All</option>
          <option>QB</option><option>RB</option><option>WR</option><option>TE</option><option>DST</option><option>K</option>
        </select>
      </label>
      <label>Tier
        <select id="filterTier">
          <option value="">All</option>
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
        </select>
      </label>
      <button id="clearFilters">Clear</button>
    </div>
  </section>

  <section class="card col-2 row-3">
    <h2>Draft Board</h2>
    <div class="table-wrap">
      <table id="board">
        <thead>
          <tr>
            <th>Player Name</th>
            <th>Position</th>
            <th>Rank</th>
            <th>Position Rank</th>
            <th>Tier</th>
            <th class="right">Recommended Auction Value</th>
            <th class="right">Actual Auction Value</th>
            <th>My Team?</th>
          </tr>
        </thead>
        <tbody id="boardBody"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
/* ---------- Data & state ---------- */
const raw = document.getElementById("players-data").textContent || "[]";
let embeddedPlayers = [];
try { embeddedPlayers = JSON.parse(raw); } catch(_) { embeddedPlayers = []; }

const LS_KEY = "ffa_draft_board_v10";
const state = {
  settings: {
    teamsCount: 12,
    budgetPerTeam: 200,
    yourTeamName: "You",
    benchSlots: 6,
    slots: { QB:1, RB:2, WR:2, TE:1, FLEX:1, DST:1, K:1 }
  },
  players: [],
  log: []
};

function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function load(){ const s = localStorage.getItem(LS_KEY); if (!s) return false; try { Object.assign(state, JSON.parse(s)); return true; } catch { return false; } }
function dollars(x){ if (!isFinite(x)) return "$0"; return "$" + Math.round(x); }
function normPos(s){ const p = String(s||"").trim().toUpperCase(); if (["DST","D/ST","DEF","D"].includes(p)) return "DST"; if (p==="PK") return "K"; if (["QB","RB","WR","TE","DST","K"].includes(p)) return p; return p || ""; }

/* ---------- KPIs ---------- */
function totalSlotsPerTeam(){ const s = state.settings.slots, bench = Number(state.settings.benchSlots)||0; return s.QB + s.RB + s.WR + s.TE + s.FLEX + s.DST + s.K + bench; }
function computeKPIs(){
  const spent = state.players.reduce((sum,p)=> sum + (p.myTeam ? (Number(p.actual)||0) : 0), 0);
  const remaining = (Number(state.settings.budgetPerTeam)||200) - spent;
  const yourCount = state.players.filter(p=>p.myTeam && Number(p.actual)>0).length;
  const openSlots = Math.max(0, totalSlotsPerTeam() - yourCount);
  const maxBid = Math.max(0, remaining - Math.max(0, openSlots - 1));
  document.getElementById("yourRemaining").textContent = dollars(remaining);
  document.getElementById("yourPlayers").textContent = yourCount;
  document.getElementById("yourMaxBid").textContent = dollars(maxBid);
}

/* ---------- Lineup auto-fill ---------- */
function assignRoster(){
  const s = state.settings.slots;
  const L = { QB:[], RB:[], WR:[], TE:[], FLEX:[], DST:[], K:[], BENCH:[] };
  const canFlex = pos => (pos==="RB"||pos==="WR"||pos==="TE");
  const mine = state.players.filter(p=>p.myTeam && Number(p.actual)>0).sort((a,b)=> a.rank - b.rank);

  for (const p of mine){
    let placed = false;
    // Primary
    if (p.pos in L){
      const need = s[p.pos] || 0;
      if (L[p.pos].length < need){ L[p.pos].push(p); placed = true; }
    }
    // FLEX
    if (!placed && canFlex(p.pos)){
      const needF = s.FLEX || 0;
      if (L.FLEX.length < needF){ L.FLEX.push(p); placed = true; }
    }
    // BENCH
    if (!placed){
      const benchNeed = Number(state.settings.benchSlots)||6;
      if (L.BENCH.length < benchNeed){ L.BENCH.push(p); placed = true; }
    }
  }
  return L;
}
function renderLineup(){
  const body = document.getElementById("lineupBody");
  const paidCell = document.getElementById("lineupPaid");
  const s = state.settings.slots;
  const L = assignRoster();
  body.innerHTML = "";
  let paid = 0;

  function rowFor(slot, arr, maxCount){
    for (let i=0; i<maxCount; i++){
      const p = arr[i];
      const name = p ? p.name : "<span class='muted'>—</span>";
      const price = p ? dollars(Number(p.actual)||0) : "$0";
      if (p) paid += Number(p.actual)||0;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${slot}</td><td class="slot"><span class="name">${name}</span></td><td class="right price">${price}</td>`;
      body.appendChild(tr);
    }
  }

  rowFor("QB", L.QB, s.QB||0);
  rowFor("RB", L.RB, s.RB||0);
  rowFor("WR", L.WR, s.WR||0);
  rowFor("TE", L.TE, s.TE||0);
  rowFor("FLEX", L.FLEX, s.FLEX||0);
  rowFor("DST", L.DST, s.DST||0);
  rowFor("K", L.K, s.K||0);
  rowFor("BENCH", L.BENCH, Number(state.settings.benchSlots)||6);

  paidCell.textContent = dollars(paid);
}

/* ---------- Recommended Players Available ---------- */
function computeNeeds(){
  const s = state.settings.slots;
  const L = assignRoster();
  const needs = {
    QB: Math.max(0, (s.QB||0) - L.QB.length),
    RB: Math.max(0, (s.RB||0) - L.RB.length),
    WR: Math.max(0, (s.WR||0) - L.WR.length),
    TE: Math.max(0, (s.TE||0) - L.TE.length),
    DST: Math.max(0, (s.DST||0) - L.DST.length),
    K:  Math.max(0, (s.K||0)  - L.K.length),
    FLEX: Math.max(0, (s.FLEX||0) - L.FLEX.length),
  };
  return needs;
}
function renderRecommendations(){
  const body = document.getElementById("recsBody");
  body.innerHTML = "";
  const needs = computeNeeds();
  const remaining = state.players.filter(p => Number(p.actual) === 0); // not drafted

  // Prioritize filling starters first, then FLEX
  const order = ["QB","RB","WR","TE","DST","K","FLEX"];
  const rows = [];
  for (const pos of order){
    const need = needs[pos] || 0;
    if (need <= 0) continue;

    let pool = [];
    if (pos === "FLEX"){
      pool = remaining.filter(p => p.pos==="RB"||p.pos==="WR"||p.pos==="TE");
    } else {
      pool = remaining.filter(p => p.pos === pos);
    }
    pool.sort((a,b)=> a.rank - b.rank);

    // Show up to 5 per position needed
    const top = pool.slice(0, Math.max(5, need));
    top.forEach(p=>{
      rows.push(`<tr><td>${pos}</td><td>${p.name}</td><td class="right mono">${dollars(p.base)}</td><td class="right">${p.rank}</td></tr>`);
    });
  }

  if (rows.length === 0){
    body.innerHTML = `<tr><td colspan="4" class="muted">No immediate starting needs. Track value and bench depth.</td></tr>`;
  } else {
    body.innerHTML = rows.join("");
  }
}

/* ---------- Positional Value Tracking ---------- */
function buildBuckets(){
  // Always show through 41–50
  const buckets = [];
  for (let start=1; start<=30; start+=5){ buckets.push([start, start+4]); }   // 1–5 … 26–30
  buckets.push([31,40]);
  buckets.push([41,50]);
  return buckets;
}
function formatPositionalValue(pos){
  const drafted = state.players.filter(p => p.pos === pos && Number(p.actual)>0);
  const spend = drafted.reduce((s,p)=> s + (Number(p.actual)||0), 0);
  const rec = drafted.reduce((s,p)=> s + (Number(p.base)||0), 0);
  if (rec <= 0) return { text: "—", cls: "" };
  const pct = ((spend - rec) / rec) * 100;
  return { text: `${Math.round(Math.abs(pct))}% ${pct>0 ? "Greater" : "Less"} Than Rec.`, cls: pct>0 ? "bad" : "good" };
}
function renderPositionalValueTracking(){
  const head = document.getElementById("pvHead");
  const body = document.getElementById("pvBody");
  const buckets = buildBuckets();

  head.innerHTML = "";
  const htr = document.createElement("tr");
  htr.innerHTML = `<th>Position</th><th>Positional Value</th><th>Remaining Players Available</th>` + buckets.map(b => `<th>${b[0]}–${b[1]}</th>`).join("");
  head.appendChild(htr);

  body.innerHTML = "";
  ["QB","RB","WR","TE"].forEach(pos => {
    const remaining = state.players.filter(p => p.pos === pos && (!p.actual || Number(p.actual) === 0));
    const valueInfo = formatPositionalValue(pos);
    const tr = document.createElement("tr");
    let html = `<td>${pos}</td><td class="value-pos ${valueInfo.cls}">${valueInfo.text}</td><td>${remaining.length}</td>`;
    for (const [start,end] of buckets){
      const count = remaining.filter(p => (Number(p.posRank)||0) >= start && (Number(p.posRank)||0) <= end).length;
      let cls = "";
      if (count === 0) cls = "bucket-0";
      else if (count === 1) cls = "bucket-1";
      html += `<td class="${cls}">${count}</td>`;
    }
    tr.innerHTML = html;
    body.appendChild(tr);
  });
}

/* ---------- Draft Log ---------- */
function logDraftEvent(name, pos, actual){
  const entry = { time: Date.now(), name, pos, actual: Number(actual)||0 };
  state.log.push(entry);
  state.log.sort((a,b)=> b.time - a.time);
  save();
  renderLog();
}
function renderLog(){
  const ul = document.getElementById("draftLog");
  ul.innerHTML = "";
  if (!state.log.length){
    ul.innerHTML = `<li class="muted">No picks yet.</li>`;
    return;
  }
  state.log.forEach(item=>{
    const li = document.createElement("li");
    li.className = "log-item";
    li.innerHTML = `<span class="who">${item.name} <span class="muted">(${item.pos})</span></span><span class="amt">${dollars(item.actual)}</span>`;
    ul.appendChild(li);
  });
}

/* ---------- Draft Board ---------- */
function renderDraftBoard(){
  const body = document.getElementById("boardBody");
  const q = (document.getElementById("search").value || "").toLowerCase();
  const fPos = document.getElementById("filterPos").value;
  const fTier = document.getElementById("filterTier").value;

  body.innerHTML = "";
  state.players
    .filter(p => !q || p.name.toLowerCase().includes(q))
    .filter(p => !fPos || p.pos === fPos)
    .filter(p => !fTier || String(p.tier) === fTier)
    .sort((a,b) => a.rank - b.rank)
    .forEach((p, idx) => {
      const tr = document.createElement("tr");
      tr.className = "pos-" + (p.pos || "UNK");
      tr.innerHTML = `
        <td>${p.name}</td>
        <td><span class="badge">${p.pos}</span></td>
        <td>${p.rank ?? ""}</td>
        <td>${p.posRank ?? ""}</td>
        <td>${p.tier ?? ""}</td>
        <td class="right mono">${dollars(p.base)}</td>
        <td class="right"><input type="number" min="0" step="1" data-i="${idx}" data-k="actual" value="${p.actual||0}"></td>
        <td>
          <select data-i="${idx}" data-k="myTeam">
            <option value="false" ${p.myTeam ? "" : "selected"}>No</option>
            <option value="true" ${p.myTeam ? "selected" : ""}>Yes</option>
          </select>
        </td>
      `;
      body.appendChild(tr);
    });

  // Wire row inputs
  body.querySelectorAll("input,select").forEach(el => el.addEventListener("change", onEdit));
  computeKPIs();
  renderLineup();
  renderRecommendations();
  renderPositionalValueTracking();
}
function onEdit(e){
  const i = Number(e.target.dataset.i);
  const k = e.target.dataset.k;
  if (k === "actual"){
    const prev = Number(state.players[i].actual)||0;
    const v = Number(e.target.value)||0;
    state.players[i].actual = v;
    if ((prev === 0 && v > 0) || (prev !== v && v > 0)){
      const p = state.players[i];
      logDraftEvent(p.name, p.pos, v);
    }
  } else if (k === "myTeam"){
    state.players[i].myTeam = (e.target.value === "true");
  }
  save();
  computeKPIs();
  renderLineup();
  renderRecommendations();
  renderPositionalValueTracking();
}

/* ---------- Import / Export ---------- */
function rowsFromSheet(sheet){ return XLSX.utils.sheet_to_json(sheet, { defval: "" }); }
function toPlayersFromRows(rows){
  // Expected columns: Player, Position, Overall, Pos Rank, Tier, Auction (Out of $200)
  return rows.map(r => ({
    name: String(r["Player"] ?? r["Name"] ?? "").trim(),
    pos: normPos(r["Position"]),
    rank: Number(r["Overall"] ?? r["Rank"] ?? 0) || 0,
    posRank: Number(r["Pos Rank"] ?? r["Position Rank"] ?? 0) || 0,
    tier: String(r["Tier"] ?? "").trim(),
    base: Number(r["Auction (Out of $200)"] ?? r["Auction"] ?? 0) || 0,
    actual: 0,
    myTeam: false
  })).filter(p => p.name && p.pos);
}
function tryImportJSON(text){
  const data = JSON.parse(text);
  if (data.players && Array.isArray(data.players)) state.players = data.players;
  else if (Array.isArray(data)) state.players = data;
  else throw new Error("JSON format not recognized.");
}
document.getElementById("importBtn").addEventListener("click", ()=> document.getElementById("importFile").click());
document.getElementById("importFile").addEventListener("change", (evt)=>{
  const file = evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    try {
      const name = file.name.toLowerCase();
      if (name.endsWith(".json")){
        tryImportJSON(e.target.result);
      } else {
        const wb = XLSX.read(new Uint8Array(e.target.result), {type:"array"});
        const sheet = wb.Sheets["Rankings and Tiers"] || wb.Sheets[wb.SheetNames[0]];
        const rows = rowsFromSheet(sheet);
        state.players = toPlayersFromRows(rows);
      }
      save(); computeKPIs(); renderLineup(); renderRecommendations(); renderPositionalValueTracking(); renderDraftBoard();
    } catch(err){
      alert("Import failed: " + err.message);
    } finally { evt.target.value = ""; }
  };
  if (file.name.toLowerCase().endsWith(".json")) reader.readAsText(file);
  else reader.readAsArrayBuffer(file);
});
document.getElementById("exportBtn").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "auction_state.json"; a.click();
  URL.revokeObjectURL(url);
});

/* ---------- Settings & Filters ---------- */
["teamsCount","budgetPerTeam","yourTeamName","benchSlots"].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("change", () => {
    state.settings.teamsCount = Number(document.getElementById("teamsCount").value)||12;
    state.settings.budgetPerTeam = Number(document.getElementById("budgetPerTeam").value)||200;
    state.settings.yourTeamName = document.getElementById("yourTeamName").value || "You";
    state.settings.benchSlots = Number(document.getElementById("benchSlots").value)||6;
    save(); computeKPIs(); renderLineup(); renderRecommendations();
  });
});
document.getElementById("search").addEventListener("input", renderDraftBoard);
document.getElementById("filterPos").addEventListener("change", renderDraftBoard);
document.getElementById("filterTier").addEventListener("change", renderDraftBoard);
document.getElementById("clearFilters").addEventListener("click", () => {
  document.getElementById("search").value = "";
  document.getElementById("filterPos").value = "";
  document.getElementById("filterTier").value = "";
  renderDraftBoard();
});

/* ---------- Init ---------- */
(function init(){
  const ok = load();
  if (!ok){ state.players = embeddedPlayers; }
  document.getElementById("teamsCount").value = state.settings.teamsCount;
  document.getElementById("budgetPerTeam").value = state.settings.budgetPerTeam;
  document.getElementById("yourTeamName").value = state.settings.yourTeamName;
  document.getElementById("benchSlots").value = state.settings.benchSlots;
  computeKPIs();
  renderLineup();
  renderRecommendations();
  renderPositionalValueTracking();
  renderDraftBoard();
  renderLog();
})();
</script>
</body>
</html>
