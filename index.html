<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fantasy Football Auction Assistant</title>
<style>
  :root { --pad: 10px; --gap: 12px; --radius: 8px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #111; background: #fafafa; }
  header { padding: 18px var(--pad); background: #111; color: #fff; }
  header h1 { margin: 0; font-size: 20px; }
  main { padding: 18px var(--pad); max-width: 1200px; margin: 0 auto; }
  .grid { display: grid; grid-template-columns: 1fr; gap: var(--gap); }
  @media (min-width: 960px) {
    .grid-2 { grid-template-columns: 1.1fr 1fr; }
    .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
  }
  .card { background: #fff; border: 1px solid #e6e6e6; border-radius: var(--radius); padding: 16px; }
  .card h2 { margin: 0 0 10px 0; font-size: 16px; }
  .row { display: flex; flex-wrap: wrap; gap: 8px 12px; align-items: center; }
  label { font-size: 13px; color: #333; }
  input, select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; min-width: 90px; }
  input[type="number"] { width: 110px; }
  button { padding: 9px 12px; border-radius: 8px; border: 1px solid #111; background: #111; color: #fff; cursor: pointer; }
  button.secondary { background: #fff; color: #111; }
  button:disabled { opacity: .6; cursor: not-allowed; }
  .table-wrap { overflow: auto; border: 1px solid #e6e6e6; border-radius: var(--radius); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th, td { padding: 8px 10px; border-bottom: 1px solid #eee; white-space: nowrap; }
  th { position: sticky; top: 0; background: #f8f8f8; z-index: 1; text-align: left; }
  tbody tr:hover { background: #fcfcfc; }
  .muted { color: #666; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .right { text-align: right; }
  .footer { margin-top: 16px; font-size: 12px; color: #666; }
  .note { background:#fff8e1; border:1px solid #ffe082; padding:8px 10px; border-radius:8px; font-size:12px; }
</style>
</head>
<body>
<header>
  <h1>Fantasy Auction Assistant — Live Inflation, Max Bids & Team Builder</h1>
</header>
<main>
  <div class="grid grid-2">
    <!-- SETTINGS -->
    <section class="card">
      <h2>League Settings</h2>
      <div class="row">
        <label>Teams
          <input id="teamsCount" type="number" min="2" value="12">
        </label>
        <label>Budget / Team
          <input id="budgetPerTeam" type="number" min="1" value="200">
        </label>
        <label>Your Team Name
          <input id="yourTeamName" type="text" value="You">
        </label>
      </div>
      <h3 class="muted" style="margin-top:14px;">Roster Slots (per team)</h3>
      <div class="row">
        <label>QB <input id="slotQB" type="number" min="0" value="1"></label>
        <label>RB <input id="slotRB" type="number" min="0" value="2"></label>
        <label>WR <input id="slotWR" type="number" min="0" value="3"></label>
        <label>TE <input id="slotTE" type="number" min="0" value="1"></label>
        <label>FLEX (RB/WR/TE) <input id="slotFLEX" type="number" min="0" value="1"></label>
        <label>DST <input id="slotDST" type="number" min="0" value="1"></label>
        <label>K <input id="slotK" type="number" min="0" value="1"></label>
        <label>Bench <input id="slotBENCH" type="number" min="0" value="6"></label>
      </div>
      <div class="row" style="margin-top:8px; gap:8px;">
        <button id="applySettings">Apply / Recalculate</button>
        <button id="resetAll" class="secondary">Reset Demo Data</button>
        <button id="exportJSON" class="secondary">Export JSON</button>
        <input id="importFile" type="file" accept=".json" style="display:none;">
        <button id="importJSON" class="secondary">Import JSON</button>
      </div>
      <div class="footer">
        <div><span class="muted">Tip:</span> Your Max Bid = Remaining Budget − $1 × (Open Slots − 1).</div>
      </div>
    </section>

    <!-- LEAGUE TOTALS / YOUR SUMMARY -->
    <section class="card">
      <h2>Snapshots</h2>
      <div class="grid grid-3">
        <div>
          <div class="muted">Total Budget</div>
          <div class="mono" id="totalBudget">$0</div>
        </div>
        <div>
          <div class="muted">Total Spent</div>
          <div class="mono" id="totalSpent">$0</div>
        </div>
        <div>
          <div class="muted">Global Inflation</div>
          <div class="mono" id="globalInflation">1.00×</div>
        </div>
      </div>
      <hr>
      <h3>Your Team</h3>
      <div class="grid grid-3">
        <div>
          <div class="muted">Remaining Budget</div>
          <div class="mono" id="yourRemaining">$0</div>
        </div>
        <div>
          <div class="muted">Open Slots</div>
          <div class="mono" id="yourOpenSlots">0</div>
        </div>
        <div>
          <div class="muted">Max Bid Now</div>
          <div class="mono" id="yourMaxBid">$0</div>
        </div>
      </div>
      <hr>
      <h3>Positional Inflation (paid $ / base $)</h3>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Pos</th><th>Factor</th><th>Drafted $</th><th>Drafted Base</th></tr></thead>
          <tbody id="posTable"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- IMPORT RANKINGS -->
  <section class="card" style="margin-top:12px;">
    <h2>Import Player Rankings (CSV)</h2>
    <div class="note">
      CSV headers can be flexible. We'll auto-detect common names:<br>
      <b>Name</b>: <i>Player, Name</i> • <b>Pos</b>: <i>Pos, Position</i> •
      <b>Projection</b>: <i>Proj, ProjPts, Points</i> •
      <b>Recommended $</b>: <i>Price, Value, Base</i> •
      <b>Tier</b>: <i>Tier</i>
    </div>
    <div class="row" style="margin-top:8px;">
      <input id="csvFile" type="file" accept=".csv">
      <select id="mergeMode">
        <option value="update">Update existing by Name (add new if not found)</option>
        <option value="replace">Replace all players with CSV</option>
        <option value="append">Append CSV to existing</option>
      </select>
      <button id="importCSV">Import CSV</button>
    </div>
  </section>

  <!-- PLAYERS -->
  <section class="card" style="margin-top:12px;">
    <h2>Players</h2>
    <div class="row" style="margin-bottom:8px;">
      <button id="addPlayer" class="secondary">Add Player</button>
      <button id="clearDraft" class="secondary">Clear Drafted Flags</button>
      <span class="muted">Edit in-place. Set <b>Drafted?</b>, price & team during the draft.</span>
    </div>
    <div class="table-wrap">
      <table id="playersTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Player</th>
            <th>Pos</th>
            <th class="right">ProjPts</th>
            <th class="right">BaseValue</th>
            <th>Tier</th>
            <th>Drafted?</th>
            <th class="right">DraftedPrice</th>
            <th>DraftedTeam</th>
            <th class="right">InflatedValue</th>
            <th class="right">YourMaxBidCap</th>
            <th class="right">SuggestedBid</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="playersBody"></tbody>
      </table>
    </div>
  </section>

  <!-- TOP TARGETS & TEAM BUILDER -->
  <div class="grid grid-2" style="margin-top:12px;">
    <section class="card">
      <h2>Top Targets (Remaining)</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Player</th><th>Pos</th><th class="right">ProjPts</th>
              <th class="right">InflatedValue</th><th class="right">SuggestedBid</th><th>Tier</th>
            </tr>
          </thead>
          <tbody id="targetsBody"></tbody>
        </table>
      </div>
    </section>
    <section class="card">
      <h2>Suggested Roster (Greedy)</h2>
      <div class="row" style="margin-bottom:8px;">
        <button id="buildRoster">Build With Current Values</button>
        <span class="muted">Greedy fill by position within remaining budget. Adjusts as you draft.</span>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Slot</th><th>Player</th><th>Pos</th><th class="right">Value</th></tr>
          </thead>
          <tbody id="builderBody"></tbody>
          <tfoot>
            <tr><th colspan="3" class="right">Total Cost (est.)</th><th class="right" id="builderCost">$0</th></tr>
          </tfoot>
        </table>
      </div>
    </section>
  </div>

  <div class="footer">Data persists to your browser (localStorage). Use Export/Import JSON to move between devices.</div>
</main>

<script>
/* ---------- Data & State ---------- */
const POSITIONS = ["QB","RB","WR","TE","DST","K"];
const state = {
  settings: {
    teamsCount: 12,
    budgetPerTeam: 200,
    yourTeamName: "You",
    slots: { QB:1, RB:2, WR:3, TE:1, FLEX:1, DST:1, K:1, BENCH:6 },
  },
  teams: [],
  players: [],
};

/* Demo players (overwrite with your data) */
const demoPlayers = [
  { name:"Josh Allen", pos:"QB", proj:380, base:35, tier:"Tier 1", drafted:false, price:0, team:"" },
  { name:"Jalen Hurts", pos:"QB", proj:360, base:32, tier:"Tier 1", drafted:false, price:0, team:"" },
  { name:"Christian McCaffrey", pos:"RB", proj:340, base:68, tier:"Tier 1", drafted:false, price:0, team:"" },
  { name:"Breece Hall", pos:"RB", proj:300, base:60, tier:"Tier 1", drafted:false, price:0, team:"" },
  { name:"CeeDee Lamb", pos:"WR", proj:320, base:62, tier:"Tier 1", drafted:false, price:0, team:"" },
  { name:"Justin Jefferson", pos:"WR", proj:315, base:58, tier:"Tier 1", drafted:false, price:0, team:"" },
  { name:"Sam LaPorta", pos:"TE", proj:240, base:22, tier:"Tier 1", drafted:false, price:0, team:"" },
  { name:"Travis Kelce", pos:"TE", proj:220, base:18, tier:"Tier 2", drafted:false, price:0, team:"" },
  { name:"49ers D/ST", pos:"DST", proj:150, base:3, tier:"Tier 1", drafted:false, price:0, team:"" },
  { name:"Justin Tucker", pos:"K", proj:140, base:2, tier:"Tier 1", drafted:false, price:0, team:"" },
];

/* ---------- Persistence ---------- */
const LS_KEY = "ffa_v1";
function save() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function load() {
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return false;
  try { Object.assign(state, JSON.parse(raw)); return true; } catch(e) { return false; }
}

/* ---------- Helpers ---------- */
function buildTeams() {
  const n = Number(state.settings.teamsCount) || 12;
  const you = state.settings.yourTeamName || "You";
  const teams = [you];
  for (let i=2;i<=n;i++) teams.push(`Team ${i}`);
  state.teams = teams;
}
function dollars(x) { if (!isFinite(x)) return "$0"; return `$${Math.round(x).toLocaleString()}`; }
function parseNum(val, fallback=0) { const n = Number(val); return isFinite(n) ? n : fallback; }
function totalSlotsPerTeam() {
  const s = state.settings.slots;
  return (s.QB+s.RB+s.WR+s.TE+s.FLEX+s.DST+s.K+s.BENCH);
}
function normHeader(h) { return (h||"").toLowerCase().replace(/[^a-z0-9]+/g,""); }

/* ---------- Calculations ---------- */
function calcSnapshots() {
  const teams = state.teams;
  const budgetPer = parseNum(state.settings.budgetPerTeam, 200);
  const totalBudget = teams.length * budgetPer;
  const drafted = state.players.filter(p => p.drafted);
  const totalSpent = drafted.reduce((sum, p) => sum + parseNum(p.price, 0), 0);

  const draftedCount = drafted.length;
  const leagueSlots = teams.length * totalSlotsPerTeam();

  const remainingBaseValue = state.players
    .filter(p => !p.drafted)
    .reduce((sum, p) => sum + parseNum(p.base, 0), 0);

  // Global Inflation
  const remainingBudget = totalBudget - totalSpent;
  const openSlots = leagueSlots - draftedCount;
  const denom = Math.max(remainingBaseValue, 0.01);
  const globalInflation = (remainingBudget - openSlots) / denom;

  // Positional inflation
  const posMap = {};
  for (const pos of POSITIONS) {
    const draftedPos = drafted.filter(p => p.pos === pos);
    const draftedBase = draftedPos.reduce((s,p)=>s+parseNum(p.base,0),0);
    const draftedSpend = draftedPos.reduce((s,p)=>s+parseNum(p.price,0),0);
    const factor = draftedBase > 0 ? draftedSpend / draftedBase : 1;
    posMap[pos] = { factor, draftedSpend, draftedBase };
  }

  // Your team
  const your = state.settings.yourTeamName || "You";
  const yourDrafted = drafted.filter(p => (p.team||"") === your);
  const yourSpent = yourDrafted.reduce((s,p)=>s+parseNum(p.price,0),0);
  const yourRemaining = budgetPer - yourSpent;
  const yourOpen = totalSlotsPerTeam() - yourDrafted.length;
  const yourMaxBid = Math.max(0, yourRemaining - Math.max(0, yourOpen - 1));

  return {
    totalBudget, totalSpent, globalInflation, posMap,
    yourRemaining, yourOpen, yourMaxBid, remainingBaseValue
  };
}

function recomputePlayerValues(snap) {
  const gi = snap.globalInflation;
  return state.players.map((p, idx) => {
    if (p.drafted) return { idx, inflated: 0, yourCap: snap.yourMaxBid, suggested: 0 };
    const posFactor = (snap.posMap[p.pos]?.factor ?? 1);
    const inflated = parseNum(p.base,0) * posFactor * gi;
    const suggested = Math.min(Math.max(0, inflated), snap.yourMaxBid);
    return { idx, inflated, yourCap: snap.yourMaxBid, suggested };
  });
}

/* ---------- CSV Import ---------- */
function parseCSV(text) {
  // Simple CSV parser that handles quoted fields and commas
  const rows = [];
  let i = 0, cur = '', inQ = false, row = [];
  while (i < text.length) {
    const ch = text[i];
    if (inQ) {
      if (ch === '"') {
        if (text[i+1] === '"') { cur += '"'; i++; }
        else { inQ = false; }
      } else { cur += ch; }
    } else {
      if (ch === '"') inQ = true;
      else if (ch === ',') { row.push(cur); cur=''; }
      else if (ch === '\n' || ch === '\r') {
        if (cur!=='' || row.length>0) { row.push(cur); rows.push(row); row=[]; cur=''; }
        // Skip \r\n
        if (ch === '\r' && text[i+1] === '\n') i++;
      } else { cur += ch; }
    }
    i++;
  }
  if (cur!=='' || row.length>0) { row.push(cur); rows.push(row); }
  return rows;
}

function importCSVToPlayers(csvText, mode="update") {
  const rows = parseCSV(csvText);
  if (!rows.length) return alert("CSV appears empty.");

  const headers = rows[0].map(normHeader);
  const data = rows.slice(1).filter(r => r.some(x => (x||'').trim()!==''));

  // Find best-match columns
  const idx = {
    name: headers.findIndex(h => ["player","name"].includes(h)),
    pos: headers.findIndex(h => ["pos","position"].includes(h)),
    proj: headers.findIndex(h => ["proj","projpts","points","projection","projected"].includes(h)),
    price: headers.findIndex(h => ["price","value","base","auction","recommended","recprice","dollars"].includes(h)),
    tier: headers.findIndex(h => ["tier"].includes(h)),
  };
  if (idx.name === -1) return alert("Couldn't find a Name/Player column.");

  function makePlayer(row) {
    const get = (i) => i>=0 && i<row.length ? row[i].trim() : "";
    const name = get(idx.name);
    const pos = (get(idx.pos) || "").toUpperCase();
    const proj = Number(get(idx.proj)) || 0;
    const base = Number(get(idx.price)) || 0;
    const tier = get(idx.tier) || "";
    return { name, pos, proj, base, tier, drafted:false, price:0, team:"" };
  }

  if (mode === "replace") {
    state.players = data.map(makePlayer).filter(p => p.name);
  } else if (mode === "append") {
    state.players = state.players.concat(data.map(makePlayer).filter(p => p.name));
  } else {
    // update: merge by name
    const map = new Map(state.players.map((p, i) => [p.name.toLowerCase(), i]));
    for (const row of data) {
      const p = makePlayer(row);
      if (!p.name) continue;
      const key = p.name.toLowerCase();
      if (map.has(key)) {
        const i = map.get(key);
        // update base (recommended price), pos/proj/tier if provided
        if (p.pos) state.players[i].pos = p.pos;
        if (!isNaN(p.proj) && p.proj>0) state.players[i].proj = p.proj;
        if (!isNaN(p.base) && p.base>=0) state.players[i].base = p.base;
        if (p.tier) state.players[i].tier = p.tier;
      } else {
        state.players.push(p);
      }
    }
  }
  save(); refresh();
}

/* ---------- UI Rendering ---------- */
const qs = (sel) => document.querySelector(sel);
const playersBody = qs("#playersBody");
const targetsBody = qs("#targetsBody");
const posTableBody = qs("#posTable");
const builderBody = qs("#builderBody");

function renderSnapshots(snap) {
  qs("#totalBudget").textContent = dollars(snap.totalBudget);
  qs("#totalSpent").textContent  = dollars(snap.totalSpent);
  qs("#globalInflation").textContent = `${snap.globalInflation.toFixed(2)}×`;
  qs("#yourRemaining").textContent = dollars(snap.yourRemaining);
  qs("#yourOpenSlots").textContent = String(snap.yourOpen);
  qs("#yourMaxBid").textContent = dollars(snap.yourMaxBid);

  posTableBody.innerHTML = "";
  for (const pos of POSITIONS) {
    const m = snap.posMap[pos];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${pos}</td>
      <td>${(m.factor||1).toFixed(2)}×</td>
      <td class="right">${dollars(m.draftedSpend||0)}</td>
      <td class="right">${dollars(m.draftedBase||0)}</td>
    `;
    posTableBody.appendChild(tr);
  }
}

function renderPlayers(snap, computed) {
  playersBody.innerHTML = "";
  state.players.forEach((p, i) => {
    const c = computed.find(x=>x.idx===i);
    const tr = document.createElement("tr");

    const posOptions = POSITIONS.map(x=>`<option value="${x}" ${x===p.pos?'selected':''}>${x}</option>`).join("");

    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input data-k="name" data-i="${i}" value="${p.name??""}" /></td>
      <td>
        <select data-k="pos" data-i="${i}">
          <option value=""></option>
          ${posOptions}
        </select>
      </td>
      <td class="right"><input type="number" step="1" data-k="proj" data-i="${i}" value="${p.proj??0}"/></td>
      <td class="right"><input type="number" step="1" data-k="base" data-i="${i}" value="${p.base??0}"/></td>
      <td><input data-k="tier" data-i="${i}" value="${p.tier??""}" /></td>
      <td>
        <select data-k="drafted" data-i="${i}">
          <option value="false" ${p.drafted? "": "selected"}>FALSE</option>
          <option value="true" ${p.drafted? "selected": ""}>TRUE</option>
        </select>
      </td>
      <td class="right"><input type="number" step="1" data-k="price" data-i="${i}" value="${p.price??0}"/></td>
      <td><input data-k="team" data-i="${i}" value="${p.team??""}" placeholder="Team name"/></td>
      <td class="right mono">${dollars(c.inflated)}</td>
      <td class="right mono">${dollars(c.yourCap)}</td>
      <td class="right mono"><b>${dollars(c.suggested)}</b></td>
      <td><button data-del="${i}" class="secondary">✕</button></td>
    `;
    playersBody.appendChild(tr);
  });

  playersBody.querySelectorAll("input,select,button").forEach(el=>{
    if (el.dataset.k) {
      el.addEventListener("change", onPlayerEdit);
    } else if (el.dataset.del) {
      el.addEventListener("click", () => {
        const idx = Number(el.dataset.del);
        state.players.splice(idx,1);
        save(); refresh();
      });
    }
  });
}

function renderTargets(computed) {
  const remaining = state.players
    .map((p,i)=>({p,i,comp:computed.find(c=>c.idx===i)}))
    .filter(x=>!x.p.drafted && x.p.pos && isFinite(x.comp.inflated))
    .sort((a,b)=>b.comp.inflated - a.comp.inflated)
    .slice(0, 30);
  targetsBody.innerHTML = "";
  for (const r of remaining) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.p.name}</td>
      <td>${r.p.pos}</td>
      <td class="right">${r.p.proj ?? 0}</td>
      <td class="right mono">${dollars(r.comp.inflated)}</td>
      <td class="right mono"><b>${dollars(r.comp.suggested)}</b></td>
      <td>${r.p.tier||""}</td>
    `;
    targetsBody.appendChild(tr);
  }
}

function buildGreedyRoster(snap, computed) {
  const s = state.settings.slots;
  const req = { QB:s.QB, RB:s.RB, WR:s.WR, TE:s.TE, DST:s.DST, K:s.K };
  const flexCount = s.FLEX;
  const yourBudget = snap.yourRemaining;
  let spend = 0;

  const byPos = {};
  for (const pos of [...POSITIONS,"FLEX"]) byPos[pos]=[];
  state.players.forEach((p,i)=>{
    const c = computed.find(x=>x.idx===i);
    if (!p.drafted && p.pos && c.inflated>0) {
      byPos[p.pos].push({p, val:c.inflated});
      if (["RB","WR","TE"].includes(p.pos)) byPos["FLEX"].push({p, val:c.inflated});
    }
  });
  for (const key in byPos) byPos[key].sort((a,b)=>b.val - a.val);

  const chosen = [];
  for (const pos of ["QB","RB","WR","TE","DST","K"]) {
    let need = req[pos]||0;
    for (const cand of byPos[pos]) {
      if (need<=0) break;
      if (spend + cand.val <= yourBudget) {
        chosen.push({slot: pos, p: cand.p, val: cand.val});
        spend += cand.val;
        need--;
      }
    }
  }
  let f = flexCount;
  for (const cand of byPos["FLEX"]) {
    if (f<=0) break;
    if (spend + cand.val <= yourBudget &&
        !chosen.find(x=>x.p.name===cand.p.name)) {
      chosen.push({slot:"FLEX", p:cand.p, val:cand.val});
      spend += cand.val;
      f--;
    }
  }

  builderBody.innerHTML = "";
  for (const row of chosen) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.slot}</td>
      <td>${row.p.name}</td>
      <td>${row.p.pos}</td>
      <td class="right mono">${dollars(row.val)}</td>
    `;
    builderBody.appendChild(tr);
  }
  qs("#builderCost").textContent = dollars(spend);
}

/* ---------- Events ---------- */
function onPlayerEdit(e) {
  const i = Number(e.target.dataset.i);
  const k = e.target.dataset.k;
  const vraw = e.target.value;
  let v = vraw;
  if (["proj","base","price"].includes(k)) v = parseNum(vraw, 0);
  if (k === "drafted") v = (vraw === "true");
  state.players[i][k] = v;
  save(); refresh();
}

function refresh() {
  buildTeams();
  const snap = calcSnapshots();
  const computed = recomputePlayerValues(snap);
  renderSnapshots(snap);
  renderPlayers(snap, computed);
  renderTargets(computed);
}

function attachSettingsBindings() {
  function pushFromInputs() {
    state.settings.teamsCount = parseNum(qs("#teamsCount").value, 12);
    state.settings.budgetPerTeam = parseNum(qs("#budgetPerTeam").value, 200);
    state.settings.yourTeamName = qs("#yourTeamName").value || "You";
    state.settings.slots.QB = parseNum(qs("#slotQB").value, 1);
    state.settings.slots.RB = parseNum(qs("#slotRB").value, 2);
    state.settings.slots.WR = parseNum(qs("#slotWR").value, 3);
    state.settings.slots.TE = parseNum(qs("#slotTE").value, 1);
    state.settings.slots.FLEX = parseNum(qs("#slotFLEX").value, 1);
    state.settings.slots.DST = parseNum(qs("#slotDST").value, 1);
    state.settings.slots.K = parseNum(qs("#slotK").value, 1);
    state.settings.slots.BENCH = parseNum(qs("#slotBENCH").value, 6);
  }
  qs("#applySettings").addEventListener("click", () => { pushFromInputs(); save(); refresh(); });
  qs("#resetAll").addEventListener("click", () => {
    state.settings = { teamsCount:12, budgetPerTeam:200, yourTeamName:"You",
      slots:{QB:1,RB:2,WR:3,TE:1,FLEX:1,DST:1,K:1,BENCH:6}};
    state.players = JSON.parse(JSON.stringify(demoPlayers));
    save();
    qs("#teamsCount").value = 12; qs("#budgetPerTeam").value = 200; qs("#yourTeamName").value = "You";
    qs("#slotQB").value=1; qs("#slotRB").value=2; qs("#slotWR").value=3; qs("#slotTE").value=1;
    qs("#slotFLEX").value=1; qs("#slotDST").value=1; qs("#slotK").value=1; qs("#slotBENCH").value=6;
    refresh();
  });
  qs("#addPlayer").addEventListener("click", () => {
    state.players.push({ name:"", pos:"", proj:0, base:0, tier:"", drafted:false, price:0, team:"" });
    save(); refresh();
  });
  qs("#clearDraft").addEventListener("click", () => {
    state.players.forEach(p => { p.drafted=false; p.price=0; p.team=""; });
    save(); refresh();
  });
  qs("#buildRoster").addEventListener("click", () => {
    const snap = calcSnapshots();
    const computed = recomputePlayerValues(snap);
    buildGreedyRoster(snap, computed);
  });
  qs("#exportJSON").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "auction_state.json"; a.click();
    URL.revokeObjectURL(url);
  });
  qs("#importJSON").addEventListener("click", () => qs("#importFile").click());
  qs("#importFile").addEventListener("change", (evt) => {
    const file = evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        Object.assign(state, data);
        qs("#teamsCount").value = state.settings.teamsCount;
        qs("#budgetPerTeam").value = state.settings.budgetPerTeam;
        qs("#yourTeamName").value = state.settings.yourTeamName;
        qs("#slotQB").value = state.settings.slots.QB;
        qs("#slotRB").value = state.settings.slots.RB;
        qs("#slotWR").value = state.settings.slots.WR;
        qs("#slotTE").value = state.settings.slots.TE;
        qs("#slotFLEX").value = state.settings.slots.FLEX;
        qs("#slotDST").value = state.settings.slots.DST;
        qs("#slotK").value = state.settings.slots.K;
        qs("#slotBENCH").value = state.settings.slots.BENCH;
        save(); refresh();
      } catch(e) { alert("Invalid JSON"); }
    };
    reader.readAsText(file);
    evt.target.value = "";
  });

  // CSV import
  qs("#importCSV").addEventListener("click", () => {
    const file = qs("#csvFile").files[0];
    if (!file) return alert("Choose a CSV file first.");
    const mode = qs("#mergeMode").value;
    const reader = new FileReader();
    reader.onload = () => importCSVToPlayers(reader.result, mode);
    reader.readAsText(file);
  });
}

function init() {
  const ok = load();
  if (!ok) {
    state.settings = { teamsCount:12, budgetPerTeam:200, yourTeamName:"You",
      slots:{QB:1,RB:2,WR:3,TE:1,FLEX:1,DST:1,K:1,BENCH:6}};
    state.players = JSON.parse(JSON.stringify(demoPlayers));
    save();
  }
  qs("#teamsCount").value = state.settings.teamsCount;
  qs("#budgetPerTeam").value = state.settings.budgetPerTeam;
  qs("#yourTeamName").value = state.settings.yourTeamName;
  qs("#slotQB").value = state.settings.slots.QB;
  qs("#slotRB").value = state.settings.slots.RB;
  qs("#slotWR").value = state.settings.slots.WR;
  qs("#slotTE").value = state.settings.slots.TE;
  qs("#slotFLEX").value = state.settings.slots.FLEX;
  qs("#slotDST").value = state.settings.slots.DST;
  qs("#slotK").value = state.settings.slots.K;
  qs("#slotBENCH").value = state.settings.slots.BENCH;

  attachSettingsBindings();
  refresh();
}
init();
</script>
</body>
</html>
