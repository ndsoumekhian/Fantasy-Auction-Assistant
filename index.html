<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fantasy Auction Assistant — Draft Board</title>
<style>
  :root { --pad: 10px; --gap: 12px; --radius: 10px; }
  * { box-sizing: border-box; }
  body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; margin: 0; color: #111; background: #f7f7f9; }
  header { padding: 18px var(--pad); background: #111; color: #fff; }
  header h1 { margin: 0; font-size: 20px; }
  main { padding: 18px var(--pad); max-width: 1280px; margin: 0 auto; }
  .grid { display: grid; gap: var(--gap); }
  .grid-2 { grid-template-columns: 1fr 1fr; }
  .draft-layout { display:grid; grid-template-columns: 0.7fr 1.3fr; gap: var(--gap); }
  .card { background: #fff; border: 1px solid #e6e6ee; border-radius: var(--radius); padding: 16px; }
  .card h2 { margin: 0 0 10px 0; font-size: 16px; }
  .row { display: flex; flex-wrap: wrap; gap: 10px 14px; align-items: center; }
  label { font-size: 13px; color: #333; }
  input, select, button { padding: 8px; border-radius: 8px; border: 1px solid #cfd1d6; font-size: 14px; }
  input[type="number"] { width: 110px; }
  .kpi { display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:12px; margin-top:8px; }
  .kpi .tile { background:#fafafa; border:1px solid #eee; border-radius:10px; padding:12px; }
  .muted { color:#666; font-size:12px; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .right { text-align:right; }
  .table-wrap { overflow:auto; border:1px solid #e6e6ee; border-radius: var(--radius); }
  table { width:100%; border-collapse: collapse; font-size:13px; }
  th, td { padding: 9px 10px; border-bottom: 1px solid #f0f0f3; white-space: nowrap; }
  th { position: sticky; top: 0; background: #f5f6fa; z-index: 1; text-align: left; }
  tbody tr:hover { filter: brightness(0.98); }
  /* Position tints */
  .pos-QB { background: #ffe5e5; }  /* red tint */
  .pos-RB { background: #e6f0ff; }  /* blue tint */
  .pos-WR { background: #e8f7e8; }  /* green tint */
  .pos-TE { background: #fff1e0; }  /* orange tint */
  .pos-DST, .pos-K { background: #f1f1f1; }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; background:#fff; }
  /* Positional Value Tracking */
  .pv-grid { width: 100%; }
  .pv-grid th, .pv-grid td { text-align: right; }
  .pv-grid th:first-child, .pv-grid td:first-child { text-align: left; }
  .pv-grid .value-pos { font-weight: 600; }
  .good { color: #0c7a43; }
  .bad { color: #b00020; }
  .bucket-1 { background: #fff5c2; }  /* yellow at 1 left */
  .bucket-0 { background: #ffd6d6; }  /* red at 0 left */
  /* Lineup table */
  .lineup th { text-align:left; }
  .lineup td { white-space: normal; }
  .slot { display:flex; justify-content:space-between; gap:8px; }
  .slot .name { overflow:hidden; text-overflow:ellipsis; }
  .slot .price { font-weight:600; }
</style>
</head>
<body>
<header>
  <h1>Fantasy Auction Assistant — Draft Board</h1>
</header>

<!-- Keep this tag and paste your existing JSON inside it (or leave [] and use your current build pipeline). -->
<script type="application/json" id="players-data">[]</script>

<main class="grid">
  <!-- Top row: My Team (lineup) + League & Team -->
  <section class="grid grid-2">
    <div class="card">
      <h2>My Team (Lineup)</h2>
      <div class="table-wrap">
        <table class="lineup">
          <thead>
            <tr><th>Slot</th><th>Player</th><th class="right">Paid</th></tr>
          </thead>
          <tbody id="lineupBody"></tbody>
          <tfoot>
            <tr><th colspan="2" class="right">Total Paid</th><th class="right" id="lineupPaid">$0</th></tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>League & Team</h2>
      <div class="row">
        <label>Teams <input id="teamsCount" type="number" min="2" value="12"></label>
        <label>Budget / Team <input id="budgetPerTeam" type="number" min="1" value="200"></label>
        <label>Your Team Name <input id="yourTeamName" type="text" value="You"></label>
        <label>Bench Slots <input id="benchSlots" type="number" min="0" value="6"></label>
      </div>
      <div class="kpi">
        <div class="tile"><div class="muted">Your Remaining Budget</div><div class="mono" id="yourRemaining">$0</div></div>
        <div class="tile"><div class="muted">Players on Your Team</div><div class="mono" id="yourPlayers">0</div></div>
        <div class="tile"><div class="muted">Your Max Bid</div><div class="mono" id="yourMaxBid">$0</div></div>
      </div>
    </div>
  </section>

  <!-- Positional Value Tracking (full width) -->
  <section class="card">
    <h2>Positional Value Tracking</h2>
    <div class="table-wrap">
      <table class="pv-grid" id="pvTable">
        <thead id="pvHead"></thead>
        <tbody id="pvBody"></tbody>
      </table>
    </div>
    <div class="muted" style="margin-top:6px;">
      A player counts as <b>drafted</b> once an <b>Actual Auction Value</b> is entered (&gt; 0). Remaining = not yet drafted.
      Positional Value = (sum Actual − sum Recommended) / sum Recommended for drafted players at that position.
      Buckets: 1–5, 6–10, …, 26–30, then 31–40, 41–50, 51–60, … (cells turn <span class="bucket-1">yellow at 1</span> and <span class="bucket-0">red at 0</span>).
    </div>
  </section>

  <!-- Bottom: small Filters (left) + narrower Draft Board (right) -->
  <section class="draft-layout">
    <div class="card">
      <h2>Filters</h2>
      <div class="controls">
        <label>Search <input id="search" type="text" placeholder="Search player..."></label>
        <label>Position
          <select id="filterPos">
            <option value="">All</option>
            <option>QB</option><option>RB</option><option>WR</option><option>TE</option><option>DST</option><option>K</option>
          </select>
        </label>
        <label>Tier
          <select id="filterTier">
            <option value="">All</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
          </select>
        </label>
        <button id="clearFilters">Clear</button>
      </div>
    </div>

    <div class="card">
      <h2>Draft Board</h2>
      <div class="table-wrap">
        <table id="board">
          <thead>
            <tr>
              <th>Player Name</th>
              <th>Position</th>
              <th>Rank</th>
              <th>Position Rank</th>
              <th>Tier</th>
              <th class="right">Recommended Auction Value</th>
              <th class="right">Actual Auction Value</th>
              <th>My Team?</th>
            </tr>
          </thead>
          <tbody id="boardBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script>
/* ---------- Data & state ---------- */
const raw = document.getElementById("players-data").textContent || "[]";
let embeddedPlayers = [];
try { embeddedPlayers = JSON.parse(raw); } catch(_) { embeddedPlayers = []; }

const LS_KEY = "ffa_draft_board_v7";
const state = {
  settings: {
    teamsCount: 12,
    budgetPerTeam: 200,
    yourTeamName: "You",
    benchSlots: 6,
    slots: { QB:1, RB:2, WR:2, TE:1, FLEX:1, DST:1, K:1 } // league structure
  },
  players: []
};

function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function load(){
  const s = localStorage.getItem(LS_KEY);
  if (!s) return false;
  try { Object.assign(state, JSON.parse(s)); return true; } catch { return false; }
}
function dollars(x){ if (!isFinite(x)) return "$0"; return "$" + Math.round(x); }

/* ---------- KPIs ---------- */
function totalSlotsPerTeam(){
  const s = state.settings.slots, bench = Number(state.settings.benchSlots)||0;
  return s.QB + s.RB + s.WR + s.TE + s.FLEX + s.DST + s.K + bench;
}
function computeKPIs(){
  const spent = state.players.reduce((sum,p)=> sum + (p.myTeam ? (Number(p.actual)||0) : 0), 0);
  const remaining = (Number(state.settings.budgetPerTeam)||200) - spent;
  const yourCount = state.players.filter(p=>p.myTeam && Number(p.actual)>0).length;
  const openSlots = Math.max(0, totalSlotsPerTeam() - yourCount);
  const maxBid = Math.max(0, remaining - Math.max(0, openSlots - 1));
  document.getElementById("yourRemaining").textContent = dollars(remaining);
  document.getElementById("yourPlayers").textContent = yourCount;
  document.getElementById("yourMaxBid").textContent = dollars(maxBid);
}

/* ---------- Lineup auto-fill ---------- */
function assignRoster(){
  const s = state.settings.slots;
  const L = { QB:[], RB:[], WR:[], TE:[], FLEX:[], DST:[], K:[], BENCH:[] };
  const canFlex = pos => (pos==="RB"||pos==="WR"||pos==="TE");
  const mine = state.players.filter(p=>p.myTeam && Number(p.actual)>0).sort((a,b)=> a.rank - b.rank);

  for (const p of mine){
    let placed = false;
    // Primary slot
    if (p.pos in L){
      const need = s[p.pos] || 0;
      if (L[p.pos].length < need){ L[p.pos].push(p); placed = true; }
    }
    // FLEX
    if (!placed && canFlex(p.pos)){
      const needF = s.FLEX || 0;
      if (L.FLEX.length < needF){ L.FLEX.push(p); placed = true; }
    }
    // BENCH
    if (!placed){
      const benchNeed = Number(state.settings.benchSlots)||6;
      if (L.BENCH.length < benchNeed){ L.BENCH.push(p); placed = true; }
    }
  }
  return L;
}
function renderLineup(){
  const body = document.getElementById("lineupBody");
  const paidCell = document.getElementById("lineupPaid");
  const s = state.settings.slots;
  const L = assignRoster();
  body.innerHTML = "";
  let paid = 0;

  function rowFor(slot, arr, maxCount){
    for (let i=0; i<maxCount; i++){
      const p = arr[i];
      const name = p ? p.name : "<span class='muted'>—</span>";
      const price = p ? dollars(Number(p.actual)||0) : "$0";
      if (p) paid += Number(p.actual)||0;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${slot}</td><td class="slot"><span class="name">${name}</span></td><td class="right price">${price}</td>`;
      body.appendChild(tr);
    }
  }
  rowFor("QB", L.QB, s.QB||0);
  rowFor("RB", L.RB, s.RB||0);
  rowFor("WR", L.WR, s.WR||0);
  rowFor("TE", L.TE, s.TE||0);
  rowFor("FLEX", L.FLEX, s.FLEX||0);
  rowFor("DST", L.DST, s.DST||0);
  rowFor("K", L.K, s.K||0);
  rowFor("BENCH", L.BENCH, Number(state.settings.benchSlots)||6);

  paidCell.textContent = dollars(paid);
}

/* ---------- Positional Value Tracking ---------- */
function buildBuckets(){
  const maxPosRank = state.players.reduce((m,p)=> Math.max(m, Number(p.posRank)||0), 0);
  const buckets = [];
  for (let start=1; start<=30; start+=5){ buckets.push([start, start+4]); }  // 1–5 ... 26–30
  let s = 31;
  while (s <= maxPosRank){ buckets.push([s, s+9]); s += 10; } // 31–40, 41–50, ...
  return buckets;
}
function formatPositionalValue(pos){
  const drafted = state.players.filter(p => p.pos === pos && Number(p.actual)>0);
  const spend = drafted.reduce((s,p)=> s + (Number(p.actual)||0), 0);
  const rec = drafted.reduce((s,p)=> s + (Number(p.base)||0), 0);
  if (rec <= 0) return { text: "—", cls: "" };
  const pct = ((spend - rec) / rec) * 100;
  return { text: `${Math.round(Math.abs(pct))}% ${pct>0 ? "Greater" : "Less"} Than Rec.`, cls: pct>0 ? "bad" : "good" };
}
function renderPositionalValueTracking(){
  const head = document.getElementById("pvHead");
  const body = document.getElementById("pvBody");
  const buckets = buildBuckets();

  head.innerHTML = "";
  const htr = document.createElement("tr");
  htr.innerHTML = `<th>Position</th><th>Positional Value</th><th>Remaining Players Available</th>` + buckets.map(b => `<th>${b[0]}–${b[1]}</th>`).join("");
  head.appendChild(htr);

  body.innerHTML = "";
  ["QB","RB","WR","TE"].forEach(pos => {
    const remaining = state.players.filter(p => p.pos === pos && (!p.actual || Number(p.actual) === 0));
    const valueInfo = formatPositionalValue(pos);
    const tr = document.createElement("tr");
    let html = `<td>${pos}</td><td class="value-pos ${valueInfo.cls}">${valueInfo.text}</td><td>${remaining.length}</td>`;
    for (const [start,end] of buckets){
      const count = remaining.filter(p => (Number(p.posRank)||0) >= start && (Number(p.posRank)||0) <= end).length;
      let cls = "";
      if (count === 0) cls = "bucket-0";
      else if (count === 1) cls = "bucket-1";
      html += `<td class="${cls}">${count}</td>`;
    }
    tr.innerHTML = html;
    body.appendChild(tr);
  });
}

/* ---------- Draft Board ---------- */
function renderDraftBoard(){
  const body = document.getElementById("boardBody");
  const q = (document.getElementById("search").value || "").toLowerCase();
  const fPos = document.getElementById("filterPos").value;
  const fTier = document.getElementById("filterTier").value;

  body.innerHTML = "";
  state.players
    .filter(p => !q || p.name.toLowerCase().includes(q))
    .filter(p => !fPos || p.pos === fPos)
    .filter(p => !fTier || String(p.tier) === fTier)
    .sort((a,b) => a.rank - b.rank)
    .forEach((p, idx) => {
      const tr = document.createElement("tr");
      tr.className = "pos-" + (p.pos || "UNK");
      tr.innerHTML = `
        <td>${p.name}</td>
        <td><span class="badge">${p.pos}</span></td>
        <td>${p.rank ?? ""}</td>
        <td>${p.posRank ?? ""}</td>
        <td>${p.tier ?? ""}</td>
        <td class="right mono">${dollars(p.base)}</td>
        <td class="right"><input type="number" min="0" step="1" data-i="${idx}" data-k="actual" value="${p.actual||0}"></td>
        <td>
          <select data-i="${idx}" data-k="myTeam">
            <option value="false" ${p.myTeam ? "" : "selected"}>No</option>
            <option value="true" ${p.myTeam ? "selected" : ""}>Yes</option>
          </select>
        </td>
      `;
      body.appendChild(tr);
    });

  body.querySelectorAll("input,select").forEach(el => el.addEventListener("change", onEdit));
  computeKPIs();
  renderLineup();
  renderPositionalValueTracking();
}
function onEdit(e){
  const i = Number(e.target.dataset.i);
  const k = e.target.dataset.k;
  if (k === "actual"){ state.players[i].actual = Number(e.target.value)||0; }
  else if (k === "myTeam"){ state.players[i].myTeam = (e.target.value === "true"); }
  save(); computeKPIs(); renderLineup(); renderPositionalValueTracking();
}

/* ---------- Settings & Filters ---------- */
["teamsCount","budgetPerTeam","yourTeamName","benchSlots"].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener("change", () => {
    state.settings.teamsCount = Number(document.getElementById("teamsCount").value)||12;
    state.settings.budgetPerTeam = Number(document.getElementById("budgetPerTeam").value)||200;
    state.settings.yourTeamName = document.getElementById("yourTeamName").value || "You";
    state.settings.benchSlots = Number(document.getElementById("benchSlots").value)||6;
    save(); computeKPIs(); renderLineup();
  });
});
document.getElementById("search").addEventListener("input", renderDraftBoard);
document.getElementById("filterPos").addEventListener("change", renderDraftBoard);
document.getElementById("filterTier").addEventListener("change", renderDraftBoard);
document.getElementById("clearFilters").addEventListener("click", () => {
  document.getElementById("search").value = "";
  document.getElementById("filterPos").value = "";
  document.getElementById("filterTier").value = "";
  renderDraftBoard();
});

/* ---------- Init ---------- */
(function init(){
  const ok = load();
  if (!ok){ state.players = embeddedPlayers; }
  document.getElementById("teamsCount").value = state.settings.teamsCount;
  document.getElementById("budgetPerTeam").value = state.settings.budgetPerTeam;
  document.getElementById("yourTeamName").value = state.settings.yourTeamName;
  document.getElementById("benchSlots").value = state.settings.benchSlots;
  computeKPIs();
  renderLineup();
  renderPositionalValueTracking();
  renderDraftBoard();
})();
</script>
</body>
</html>
